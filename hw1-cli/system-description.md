# Описание работы системы

Bash-like интерпретатор выражений.

## Чёрный ящик

### Вход
Строки с выражениями вида `echo 42 | grep 4 | wc > lol.txt`, вводимые пользователем в консоль при приглашении к вводу.

### Поведение
Производится попытка выполнить последовательность операций, указанную в очередном выражении.

- В случае неудачи печатается сообщение об ошибке (синтаксической / выполнения команды). При ошибке выполнения команды эффекты, накопленные при выполнении части команд до обнаружения ошибки, сохраняются.

- В случае успеха сохраняются все эффекты, накопленные при выполнении алгоритма, описанного выражением. Никаких других эффектов не ожидается.

И при успехе, и при неудаче отображается приглашение к вводу, кроме случая успешного выполнения команды `exit`, завершающей работу системы.

#### Синтаксис

##### Команды

1. `cat <file>` — вывести содержимое файла `file`;
2. `echo (<arg>)*` — вывести переданные аргументы;
3. `wc <file>` — вывести количество строк, слов и байт в файле `file`;
4. `pwd` — вывести путь к текущей директории;
5. `exit` — выйти из интерпретатора;
6. `<cmd> (<arg>)*` — другие, соответствующие исполняемым файлам в текущей директории, или в директории, указанной в переменной окружения `ENV_PATH`, или, если `cmd` — путь, ином месте (порядок поиска соответствующий).

У каждой комады есть доступ к входному потоку, выходному потоку и потоку ошибок, определяемым дескрипторами. У каждой команды свой набор дескрипторов, значения которых могут совпадать для разных команд. Значение дескриптора — путь к файлу. По умолчанию stdin, stdout и stderr соответственно. Про изменение — в разделе [Перенаправление потоков](#перенаправление-потоков).

##### Подстановки

Можно задавать переменные окружения: `<var>=<val>`. Все вхождения `$<var>` будут заменены на `val` перед выполнением команд.

Также реализуются подстановки выражений: `$(<expr>)`. Сначала вычисляется выражение `expr`, затем соответствующая строка `$(<expr>)` заменяется на вывод `expr` в stdin.

##### Строки

1. `'<str>'` — строка любых печатаемых символов;
2. `"<rich_str>"` — строка любых печатаемых символов, возможно, с подстановками;

##### Перенаправление потоков

1. `<expr> > <file>` — перенаправление выходного потока в файл `file` (новый или, если уже существует файл с таким именем, очищаемый системой перед записью);
2. `<expr> >> <file>` — перенаправление выходного потока в файл `file` в режиме дозаписи (новый, если не существует);
3. `<expr> < <file>` — перенаправление входного потока в файл `file` (ошибка, если не существует);
4. `<expr> 2> <file>` — перенаправление потока ошибок в файл `file` (новый или, если уже существует файл с таким именем, очищаемый системой перед записью);
5. `<expr> 2>> <file>` — перенаправление потока ошибок в файл `file` в режиме дозаписи (новый, если не существует).

##### Пайплайны

Реализуется возможность конкатенировать команды в пайплайн-выражения следующим образом: `<cmd1> | <cmd2>`. Сначала выполняется `cmd1`, затем `cmd2` так, что текст, записанный первой в stdout, подставляется в stdin второй.

##### Операторы

1. `<expr1> && <expr2>` — выполняется `expr1` и, в случае успеха, `expr2`;
2. `<expr1> || <expr2>` — выполняется `expr1` и, в случае неуспеха, `expr2`;
3. `{<expr>}` — группировка выражений.

Общий успех выражения с операторами аналогичен соответствующим логическим операторам.

Ассоциативность пайплайн-оператора `|` и операторов `&&` и `||` в порядке убывания: `&&`, `||`, `|`.

## Внутреннее устройство

### Компоненты

#### Интерпретатор

#### Парсер

#### Подстановщик

#### Исполнитель

### Классы

#### Языковые

#### Системные

## Описание процесса

- Разбор поступившей строки с помощью Parser, возвращающий представление выражения в виде бинарного дерева синтаксического разбора, листьями которого являются неразрешенные командные выражения (иерархия AbstractExpression)
- Исполнение выражения с помощью рекурсивного спуска из корня дерева разбора:
  - исполнить pipe: исполнить левое выражение, в случае нулевого кода возврата передать в stdin правого данные, записанные левым в свой stdout, и выполнить правое
  - исполнить &&: исполнить левое выражение, в случае нулевого кода возврата исполнить правое выражение
  - исполнить ||: исполнить левое выражение, в случае ненулевого кода возврата исполнить правое выражение
  - исполнить неразрешенное командное выражение: с помощью Substitutor осуществить подстановки и получить разрешенное командное выражение, с помощью Parser разобрать выражение и  получить объект Command, произвести запуск соответствующего команде процесса с помощью Executor
